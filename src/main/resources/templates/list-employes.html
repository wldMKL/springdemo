<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Employés</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            min-height: 100vh;
            background: #0f0f10;
            color: #f0ede8;
            font-family: 'DM Sans', Arial, sans-serif;
        }
        .topbar {
            background: rgba(15,15,16,.9);
            border-bottom: 1px solid rgba(255,255,255,.07);
            padding: 0 2rem;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .topbar-brand { display: flex; align-items: center; gap: .75rem; text-decoration: none; color: #f0ede8; }
        .monogram {
            width: 34px; height: 34px;
            background: linear-gradient(135deg, #c8a96e, #9c7d4d);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; color: #111;
        }
        .topbar-right { display: flex; align-items: center; gap: 1rem; }
        .user-info { font-size: .85rem; color: #7a7470; }
        .user-info strong { color: #f0ede8; margin: 0 .5rem; }
        .badge { display: inline-block; font-size: .7rem; padding: .2em .6em; border-radius: 20px; text-transform: uppercase; }
        .badge-admin { background: rgba(224,95,95,.15); color: #e07070; border: 1px solid rgba(224,95,95,.2); }
        .badge-emp { background: rgba(106,175,218,.15); color: #7ec5e8; border: 1px solid rgba(106,175,218,.2); }
        .btn-logout {
            padding: .5rem 1rem;
            background: transparent;
            border: 1px solid rgba(255,255,255,.07);
            border-radius: 8px;
            color: #7a7470;
            font-size: .8rem;
            cursor: pointer;
        }
        .btn-logout:hover { border-color: rgba(224,95,95,.4); color: #e07070; }
        .flash { padding: .85rem 1rem; border-radius: 10px; margin: 1rem auto; max-width: 1040px; display: flex; align-items: center; gap: .7rem; }
        .flash.success { background: rgba(95,184,138,.1); border: 1px solid rgba(95,184,138,.25); color: #7ed4a8; }
        .flash.error { background: rgba(224,95,95,.1); border: 1px solid rgba(224,95,95,.25); color: #e07070; }
        .page { max-width: 1040px; margin: 0 auto; padding: 2rem 1.5rem; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .page-header h1 { font-size: 2rem; font-weight: 300; color: #f0ede8; }
        .page-header h1 span { color: #c8a96e; }
        .btn-new {
            display: inline-flex; align-items: center; gap: .5rem;
            padding: .65rem 1.25rem;
            background: linear-gradient(135deg, #c8a96e, #9c7d4d);
            border: none; border-radius: 9px; color: #111;
            font-size: .82rem; font-weight: 500;
            text-decoration: none; cursor: pointer;
        }
        .btn-new:hover { opacity: .9; }
        .table-card { background: #18181b; border: 1px solid rgba(255,255,255,.07); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        thead th {
            padding: .9rem 1.25rem; font-size: .7rem; font-weight: 500;
            text-transform: uppercase; color: #7a7470; background: #1f1f23;
            border-bottom: 1px solid rgba(255,255,255,.07); text-align: left;
        }
        tbody td { padding: .85rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,.04); }
        tbody tr:hover { background: rgba(255,255,255,.025); }
        .matricule-chip {
            display: inline-block; background: rgba(200,169,110,.08);
            border: 1px solid rgba(200,169,110,.15); border-radius: 6px;
            padding: .2em .65em; font-size: .78rem; color: #c8a96e;
        }
        .employee-cell { display: flex; align-items: center; gap: .75rem; }
        .avatar {
            width: 34px; height: 34px; border-radius: 50%;
            background: linear-gradient(135deg, #2a2a30, #3a3a42);
            border: 1px solid rgba(255,255,255,.07);
            display: flex; align-items: center; justify-content: center;
            font-size: .8rem; color: #c8a96e;
        }
        .actions-cell { display: flex; gap: .4rem; justify-content: flex-end; }
        .btn-icon {
            width: 32px; height: 32px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,.07); background: transparent;
            display: flex; align-items: center; justify-content: center;
            color: #7a7470; cursor: pointer; text-decoration: none;
        }
        .btn-icon.edit:hover { border-color: rgba(200,169,110,.4); color: #c8a96e; background: rgba(200,169,110,.08); }
        .btn-icon.del:hover { border-color: rgba(224,95,95,.4); color: #e07070; background: rgba(224,95,95,.07); }
        .empty-state { text-align: center; padding: 3rem 1rem; color: #7a7470; }
        .empty-state i { font-size: 2rem; margin-bottom: .75rem; }
    </style>
</head>
<body>

<nav class="topbar">
    <a class="topbar-brand" href="#">
        <div class="monogram">RH</div>
        <span>Espace RH</span>
    </a>
    <div class="topbar-right">
        <div class="user-info">
            <i class="bi bi-person-circle"></i>
            <strong sec:authentication="name">Utilisateur</strong>
            <span sec:authorize="hasRole('ADMIN')" class="badge badge-admin">Admin</span>
            <span sec:authorize="hasRole('EMPLOYE')" class="badge badge-emp">Employé</span>
        </div>
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn-logout">
                <i class="bi bi-box-arrow-right"></i> Déconnexion
            </button>
        </form>
    </div>
</nav>

<div th:if="${successMessage}" class="flash success">
    <i class="bi bi-check-circle-fill"></i>
    <span th:text="${successMessage}"></span>
</div>

<div th:if="${errorMessage}" class="flash error">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <span th:text="${errorMessage}"></span>
</div>

<main class="page">
    <div class="page-header">
        <div>
            <h1>Liste des <span>Employés</span></h1>
            <p>Gérez l'ensemble du personnel</p>
        </div>
        <a th:href="@{/add}" sec:authorize="hasRole('ADMIN')" class="btn-new">
            <i class="bi bi-plus-lg"></i> Nouvel employé
        </a>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>Matricule</th>
                    <th>Employé</th>
                    <th style="text-align:right">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="e : ${listEmployes}">
                    <td>
                        <span class="matricule-chip" th:text="${e.matricule}">0</span>
                    </td>
                    <td>
                        <div class="employee-cell">
                            <div class="avatar">
                                <span th:if="${e.nom != null and !e.nom.isEmpty()}" 
                                      th:text="${e.nom.substring(0,1)}">?</span>
                                <span th:unless="${e.nom != null and !e.nom.isEmpty()}">?</span>
                            </div>
                            <span th:text="${e.nom}">Nom</span>
                        </div>
                    </td>
                    <td>
                        <div class="actions-cell">
                            <a th:href="@{/edit(id=${e.matricule})}" 
                               class="btn-icon edit" 
                               title="Modifier" 
                               sec:authorize="hasRole('ADMIN')">
                                <i class="bi bi-pencil"></i>
                            </a>
                            
                            <!-- ✅ CORRECTION : Utilisation de data-attributes au lieu de onclick avec String -->
                            <button type="button"
                                    class="btn-icon del delete-btn" 
                                    title="Supprimer"
                                    sec:authorize="hasRole('ADMIN')"
                                    th:attr="data-id=${e.matricule},data-nom=${e.nom}">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                
                <tr th:if="${listEmployes == null or listEmployes.isEmpty()}">
                    <td colspan="3">
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>Aucun employé trouvé</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</main>

<script>
// ✅ Gestion de la suppression avec data-attributes
document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const nom = this.getAttribute('data-nom');
        
        if (confirm('Voulez-vous vraiment supprimer l\'employé ' + nom + ' (matricule ' + id + ') ?')) {
            window.location.href = '/delete?id=' + id;
        }
    });
});
</script>

</body>
</html>